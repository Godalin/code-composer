"""
节奏型预设与生成

节奏库按拍号分类：4/4 和 3/4（6/8 作为 3/4 对待）
每个风格通过 (权重, 节奏名称) 的元组引用节奏型

强弱级别：
- 0: 弱拍（weak）      -> vol 75
- 1: 次强拍（medium）   -> vol 85
- 2: 强拍（strong）     -> vol 95
- 3: 重音（accent）     -> vol 100
"""

from typing import List, Tuple, Dict

# 节奏模式：(时值列表, 强弱列表)
RhythmPattern = Tuple[List[str], List[int]]
# 风格条目：(权重, 节奏名称)
StyleEntry = Tuple[int, str]
# 最终预设：(模式列表, 权重列表)
RhythmPreset = Tuple[List[RhythmPattern], List[int]]

# ===== 全局节奏库 =====

# 4/4 节奏库
RHYTHM_4_BEAT: Dict[str, RhythmPattern] = {
    # 基础
    "even_4": (['4', '4', '4', '4'], [2, 1, 2, 1]),
    "half_2": (['2', '4', '4'], [2, 1, 1]),
    "4_2_4": (['4', '2', '4'], [2, 1, 1]),
    "two_half": (['2', '2'], [2, 1]),
    "whole": (['1'], [2]),
    "4_4_2": (['4', '4', '2'], [2, 1, 2]),
    # 八分
    "8x8": (['8', '8', '8', '8', '8', '8', '8', '8'], [2, 0, 1, 0, 2, 0, 1, 0]),
    "8_8_4x3": (['8', '8', '4', '4', '4'], [2, 0, 1, 2, 1]),
    "4_8_8_4_4": (['4', '8', '8', '4', '4'], [2, 1, 0, 2, 1]),
    "8x4_4x2": (['8', '8', '8', '8', '4', '4'], [2, 0, 1, 0, 2, 1]),
    "4x2_8x4": (['4', '4', '8', '8', '8', '8'], [2, 1, 2, 0, 1, 0]),
    "4_8x4_4": (['4', '8', '8', '8', '8', '4'], [2, 1, 0, 2, 0, 1]),
    "8x4_2": (['8', '8', '8', '8', '2'], [2, 0, 1, 0, 2]),
    "2_8x4": (['2', '8', '8', '8', '8'], [2, 2, 0, 1, 0]),
    "8_8_4_8_8_4": (['8', '8', '4', '8', '8', '4'], [2, 0, 1, 2, 0, 1]),
    # 十六分
    "16x4_8_8_4x2": (['16', '16', '16', '16', '8', '8', '4', '4'], [2, 0, 0, 0, 1, 0, 2, 1]),
    "4_16x4_8_8_4": (['4', '16', '16', '16', '16', '8', '8', '4'], [2, 1, 0, 0, 0, 2, 0, 1]),
    "8_16_16_8_16_16_4x2": (['8', '16', '16', '8', '16', '16', '4', '4'], [2, 0, 0, 1, 0, 0, 2, 1]),
    "16x8_4x2": (['16', '16', '16', '16', '16', '16', '16', '16', '4', '4'], [2, 0, 0, 0, 1, 0, 0, 0, 2, 1]),
    # 三连
    "6x6": (['6', '6', '6', '6', '6', '6'], [2, 0, 0, 1, 0, 0]),
    "12x12": (['12', '12', '12', '12', '12', '12', '12', '12', '12', '12', '12', '12'], [2, 0, 0, 1, 0, 0, 2, 0, 0, 1, 0, 0]),
    "6x3_4x2": (['6', '6', '6', '4', '4'], [2, 0, 0, 2, 1]),
    "4_6x3_4": (['4', '6', '6', '6', '4'], [2, 1, 0, 0, 2]),
    # 切分
    "synco_8_4_8_4_4": (['8', '4', '8', '4', '4'], [2, 3, 0, 2, 1]),
    "synco_4_8_4_8_4": (['4', '8', '4', '8', '4'], [2, 1, 3, 0, 1]),
    "synco_8_8_4_8_8_4": (['8', '8', '4', '8', '8', '4'], [2, 0, 3, 2, 0, 1]),
}

# 3/4 节奏库（包括 3/4 和 6/8）
RHYTHM_3_BEAT: Dict[str, RhythmPattern] = {
    # 3/4
    "even_3": (['4', '4', '4'], [2, 1, 1]),
    "2_4": (['2', '4'], [2, 1]),
    "4_8_8_4": (['4', '8', '8', '4'], [2, 0, 0, 1]),
    "8_8_4_4": (['8', '8', '4', '4'], [2, 0, 1, 1]),
    "synco_8_4_8_4": (['8', '4', '8', '4'], [2, 3, 0, 1]),
    "4_2": (['4', '2'], [2, 1]),
    "8x6": (['8', '8', '8', '8', '8', '8'], [2, 0, 1, 0, 1, 0]),
    # 6/8
    "8x6_beat": (['8', '8', '8', '8', '8', '8'], [2, 0, 0, 1, 0, 0]),
    "dot4_8_8_dot4": (['4', '8', '8', '4'], [2, 0, 0, 1]),
    "dot4_dot4_8_8": (['4', '4', '8', '8'], [2, 1, 0, 0]),
    "8_8_dot4_8_8": (['8', '8', '4', '8', '8'], [2, 0, 0, 1, 0]),
    "dot4_8_8_8_8": (['4', '8', '8', '8', '8'], [2, 0, 0, 1, 0]),
    "8_8_8_dot4_8": (['8', '8', '8', '4', '8'], [2, 0, 0, 1, 0]),
}


def _resolve_rhythm_entries(entries: List[StyleEntry], rhythm_lib: Dict[str, RhythmPattern]) -> RhythmPreset:
    """根据 (权重, 名称) 列表和节奏库解析出最终的 (模式列表, 权重列表)"""
    patterns = []
    weights = []
    for weight, name in entries:
        if name not in rhythm_lib:
            raise ValueError(f"节奏名称 '{name}' 不存在于库中")
        patterns.append(rhythm_lib[name])
        weights.append(weight)
    return patterns, weights

def _default_rhythm() -> RhythmPreset:
    """4/4 默认风格"""
    entries: List[StyleEntry] = [
        (1, "even_4"), (1, "half_2"), (2, "4_2_4"), (2, "two_half"), (1, "whole"), (2, "4_4_2"),
        (5, "8x8"), (4, "8_8_4x3"), (4, "4_8_8_4_4"), (5, "8x4_4x2"), (5, "4x2_8x4"), (4, "4_8x4_4"), 
        (4, "8x4_2"), (5, "2_8x4"), (4, "8_8_4_8_8_4"),
        (7, "16x4_8_8_4x2"), (6, "4_16x4_8_8_4"), (7, "8_16_16_8_16_16_4x2"), (6, "16x8_4x2"),
        (3, "6x6"), (2, "12x12"), (3, "6x3_4x2"), (2, "4_6x3_4"),
        (7, "synco_8_4_8_4_4"), (6, "synco_4_8_4_8_4"), (7, "synco_8_8_4_8_8_4"),
    ]
    return _resolve_rhythm_entries(entries, RHYTHM_4_BEAT)


def _jazz_rhythm() -> RhythmPreset:
    """4/4 爵士风格"""
    entries: List[StyleEntry] = [
        (9, "6x6"), (9, "12x12"), (8, "6x3_4x2"), (8, "4_6x3_4"),
        (9, "6x6"), (9, "12x12"), (8, "6x3_4x2"), (8, "4_6x3_4"),
        (9, "6x6"), (9, "12x12"),
        (5, "synco_8_4_8_4_4"),
        (5, "synco_4_8_4_8_4"),
        (5, "synco_8_8_4_8_8_4"),
        (2, "8x8"), (4, "8_8_4x3"),
        (3, "4_8_8_4_4"),
        (5, "16x4_8_8_4x2"), (5, "4_16x4_8_8_4"),
        (1, "two_half"), (1, "even_4"), (1, "half_2"),
    ]
    return _resolve_rhythm_entries(entries, RHYTHM_4_BEAT)


def _waltz_rhythm() -> RhythmPreset:
    """3/4 圆舞曲风格"""
    entries: List[StyleEntry] = [
        (5, "even_3"),
        (3, "2_4"),
        (6, "4_8_8_4"),
        (4, "8_8_4_4"),
        (4, "synco_8_4_8_4"),
        (2, "4_2"),
        (3, "8x6"),
    ]
    return _resolve_rhythm_entries(entries, RHYTHM_3_BEAT)


def _minuet_rhythm() -> RhythmPreset:
    """3/4 小步舞曲风格，典雅精致"""
    entries: List[StyleEntry] = [
        (10, "8x6_beat"),
        (3, "even_3"),
        (1, "4_8_8_4"),
        (1, "8_8_4_4"),
        (2, "synco_8_4_8_4"),
    ]
    return _resolve_rhythm_entries(entries, RHYTHM_3_BEAT)


def _chinese_rhythm() -> RhythmPreset:
    """4/4 中国风格 - 温婉大气，着重长音符和对称节奏"""
    entries: List[StyleEntry] = [
        # 长音符为主：全音符、二分音符
        (3, "whole"), (4, "two_half"), (3, "4_2_4"),
        # 缓和的四分音符
        (2, "even_4"), (1, "half_2"),
        # 温和的八分节奏，避免过快
        (2, "4_8_8_4_4"), (2, "8_8_4x3"), (1, "8x4_4x2"),
        # 移除三连音，保持平缓
        # (1, "6x3_4x2"), (1, "4_6x3_4"),
        (1, "synco_8_4_8_4_4"),
    ]
    return _resolve_rhythm_entries(entries, RHYTHM_4_BEAT)


def get_rhythm(style: str) -> RhythmPreset:
    """根据风格名称获取节奏预设"""
    if style == 'default':
        return _default_rhythm()
    if style == 'jazz':
        return _jazz_rhythm()
    if style == 'waltz':
        return _waltz_rhythm()
    if style == 'minuet':
        return _minuet_rhythm()
    if style == 'chinese':
        return _chinese_rhythm()
    raise ValueError(f"未知的节奏风格: {style}")


def list_rhythm_styles() -> List[str]:
    return ['default', 'jazz', 'waltz', 'minuet', 'chinese']
